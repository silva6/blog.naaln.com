<!doctype html>




<html class="theme-next muse" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="ByVfaP_E3b9ZYRUGhNAUFSQKL8mJQwUehpQwoxJ5n-c" />










  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="dnsmasq," />





  <link rel="alternate" href="/atom.xml" title="Why·Liam·Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="DnsmasqDnsmasq is lightweight, easy to configure DNS forwarder and DHCP server. It is designed to provide DNS and, optionally, DHCP, to a small network. It can serve the names of local machines which">
<meta property="og:type" content="article">
<meta property="og:title" content="Dnsmasq">
<meta property="og:url" content="https://blog.naaln.com/2013/06/dnsmasq/index.html">
<meta property="og:site_name" content="Why·Liam·Blog">
<meta property="og:description" content="DnsmasqDnsmasq is lightweight, easy to configure DNS forwarder and DHCP server. It is designed to provide DNS and, optionally, DHCP, to a small network. It can serve the names of local machines which">
<meta property="og:updated_time" content="2016-10-20T19:59:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dnsmasq">
<meta name="twitter:description" content="DnsmasqDnsmasq is lightweight, easy to configure DNS forwarder and DHCP server. It is designed to provide DNS and, optionally, DHCP, to a small network. It can serve the names of local machines which">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'XILKIWTAM9',
      apiKey: '99d43a85f328d00214c5de8007ce7920',
      indexName: 'blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.naaln.com/2013/06/dnsmasq/"/>





  <title> Dnsmasq | Why·Liam·Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47966442-2', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Why·Liam·Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">人生若如初見</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-technology">
          <a href="/categories/technology/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-code"></i> <br />
            
            技术
          </a>
        </li>
      
        
        <li class="menu-item menu-item-jottings">
          <a href="/categories/jottings/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-language"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tour">
          <a href="/categories/tour/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-globe"></i> <br />
            
            旅游
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://blog.naaln.com/2013/06/dnsmasq/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Liam">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/3387850?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Why·Liam·Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Why·Liam·Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Dnsmasq
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-06-22T05:56:00-04:00">
                2013-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2013/06/dnsmasq/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2013/06/dnsmasq/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Dnsmasq"><a href="#Dnsmasq" class="headerlink" title="Dnsmasq"></a>Dnsmasq</h1><p><a href="http://en.wikipedia.org/wiki/Dnsmasq" title="http://en.wikipedia.org/wiki/Dnsmasq" target="_blank" rel="external">Dnsmasq</a> is lightweight, easy to configure DNS forwarder and DHCP server. It is designed to provide DNS and, optionally, DHCP, to a small network. It can serve the names of local machines which are not in the global DNS. The DHCP server integrates with the DNS server and allows machines with DHCP-allocated addresses to appear in the DNS with names configured either in each host or in a central configuration file. Dnsmasq supports static and dynamic DHCP leases and BOOTP for network booting of disk-less machines. </p>
<p>It is already installed and preconfigured on OpenWrt. See → <a href="http://wiki.openwrt.org/doc/uci/dhcp" title="doc:uci:dhcp" target="_blank" rel="external">/etc/config/dhcp</a>. </p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>The configuration is done with help of the uci-configuration file: <a href="http://wiki.openwrt.org/doc/uci/dhcp" title="doc:uci:dhcp" target="_blank" rel="external">/etc/config/dhcp</a>, but you can use this together with the file <code>[/etc/dnsmasq.conf](http://wiki.openwrt.org/doc/uci/dhcp?&amp;#using_plain_dnsmasqconf &quot;doc:uci:dhcp&quot;)</code>. </p>
<p>Depending on the setting in the uci-file, you may also use the files <code>/etc/ethers</code> and <code>/etc/hosts</code> additionally. </p>
<h3 id="etc-config-dhcp"><a href="#etc-config-dhcp" class="headerlink" title="/etc/config/dhcp"></a>/etc/config/dhcp</h3><p>→ <a href="http://wiki.openwrt.org/doc/uci/dhcp" title="doc:uci:dhcp" target="_blank" rel="external">/etc/config/dhcp</a> is a UCI configuration file and as such documented exclusively in <a href="http://wiki.openwrt.org/doc/uci" title="doc:uci" target="_blank" rel="external">uci</a>. Almost all settings can be configured with it! </p>
<h3 id="etc-dnsmasq-conf"><a href="#etc-dnsmasq-conf" class="headerlink" title="/etc/dnsmasq.conf"></a>/etc/dnsmasq.conf</h3><p>You can use <code>/etc/dnsmasq.conf</code> in addition, see above. </p>
<p>Example: By default, dnsmasq comes configured to put your hosts into the <code>.lan</code> domain. This is specified in the configuration file as: </p>
<h1 id="allow-etc-hosts-and-dhcp-lookups-via-lan"><a href="#allow-etc-hosts-and-dhcp-lookups-via-lan" class="headerlink" title="allow /etc/hosts and dhcp lookups via *.lan"></a>allow /etc/hosts and dhcp lookups via *.lan</h1><p>   local=/lan/</p>
<p>   domain=lan</p>
<p>You can change this to whatever you’d like your home domain to be. Also, if you want your hosts to be available via your home domain without having to specify the domain in your </p>
<p>   /etc/hosts</p>
<p>file, add the <code>expand-hosts</code> directive to your <code>/etc/dnsmasq.conf</code>-file. </p>
<p>As an example, without <code>expand-hosts</code>, you can only reach <em>router, ubuntu-desktop and ubuntu-laptop</em>. With <em>expand-hosts</em> on, you can reach <em>router, router.lan, ubuntu-desktop, ubuntu-desktop.lan, etc</em>. This probably matches what you’re looking for anyway. </p>
<p>Without this setting, you’ll have to add <em>.lan</em> entries to your <code>/etc/hosts</code>. </p>
<h3 id="etc-ethers"><a href="#etc-ethers" class="headerlink" title="/etc/ethers"></a>/etc/ethers</h3><p>In <code>/etc/ethers</code> static lease entries can be assigned. See → <a href="http://wiki.openwrt.org/doc/uci/dhcp#static_leases" title="doc:uci:dhcp" target="_blank" rel="external">static_leases</a>. </p>
<h3 id="etc-hosts"><a href="#etc-hosts" class="headerlink" title="/etc/hosts"></a>/etc/hosts</h3><p>In <code>/etc/hosts</code> DNS entries are configured. dnsmasq will utilize these entries to answer DNS queries on your network. </p>
<p>Format: </p>
<p>   [IP_address] host_name host_name_short …</p>
<p>Example: </p>
<p>   192.168.1.1 router OpenWrt localhost</p>
<p>   192.168.1.2 debian-server</p>
<p>   192.168.1.3 ubuntu-laptop</p>
<h3 id="DNS-and-DHCP-Ports"><a href="#DNS-and-DHCP-Ports" class="headerlink" title="DNS and DHCP Ports"></a>DNS and DHCP Ports</h3><p>DNS needs TCP and UDP port 53 open on the firewall. DHCP needs UDP ports 67 and 68 open from your zone to/from the firewall. See <a href="http://wiki.openwrt.org/doc/recipes/guest-wlan" title="http://wiki.openwrt.org/doc/recipes/guest-wlan" target="_blank" rel="external">http://wiki.openwrt.org/doc/recipes/guest-wlan</a> and <a href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html" title="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html" target="_blank" rel="external">http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html</a> (viz “–dhcp-alternate-port”) for more information. </p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><h3 id="Add-a-secondary-DNS"><a href="#Add-a-secondary-DNS" class="headerlink" title="Add a secondary DNS"></a>Add a secondary DNS</h3><p>What to do if you already have a DNS server(secondary DNS server) but you want your router(primary DNS server) to resolve some of the DNS queries? Simply do the following: </p>
<p>   rm /etc/resolv.conf</p>
<p>That will remove the resolv.conf symlink. Then we will add the ip address of the secondary DNS inside the /etc/resolv.conf file </p>
<p>   echo “nameserver 192.168.1.2”&gt;/etc/resolv.conf</p>
<p>Replace 192.168.1.2 by the ip of your dns server then reboot or restart the dnsmasq service. </p>
<p>   reboot</p>
<p>or </p>
<p>   killall dnsmasq</p>
<p>   /etc/init.d/dnsmasq start</p>
<p>Then you’ll need to set up your secondary dns for resolving internet’s DNS queries: ssh into your router then: </p>
<p>   cat /tmp/resolv.conf.auto</p>
<p>it will give you something like this: </p>
<p>   nameserver 212.68.193.110</p>
<p>   nameserver 212.68.193.196</p>
<p>Copy the information and then add it to your secondary DNS’s /etc/resolv.conf: into your secondary dns do: </p>
<p>   rm /etc/resolv.conf</p>
<p>   echo “nameserver 212.68.193.110”&gt;&gt;/etc/resolv.conf</p>
<p>   echo “nameserver 212.68.193.196”&gt;&gt;/etc/resolv.conf</p>
<p>Replace 212.68.193.110 and 212.68.193.196 with the IP addresses you have gotten with the cat /tmp/resolv.conf.auto command. </p>
<h3 id="Configuring-dnsmasq-to-forward-dns-requests-to-public-dns-servers"><a href="#Configuring-dnsmasq-to-forward-dns-requests-to-public-dns-servers" class="headerlink" title="Configuring dnsmasq to forward dns requests to public dns servers"></a>Configuring dnsmasq to forward dns requests to public dns servers</h3><p>If you want to use public dns servers<sup><a href="#fn__1">1)</a></sup> to resolve public dns queries, you can configure dnsmasq for it. You can even specify more than three nameservers<sup><a href="#fn__2">2)</a></sup>. </p>
<p>Just add the following lines to /etc/dnsmasq.conf to use Google Public DNS. </p>
<p>   server=8.8.8.8</p>
<p>   server=8.8.4.4</p>
<p>In case you prefer to use <a href="http://wiki.openwrt.org/doc/techref/uci" title="doc:techref:uci" target="_blank" rel="external">OpenWrt UCI</a>, you may issue the following commands. </p>
<p>   uci add_list dhcp.@dnsmasq[-1].server=8.8.8.8</p>
<p>   uci add_list dhcp.@dnsmasq[-1].server=8.8.4.4</p>
<p>   uci commit dhcp</p>
<p>You may also edit /etc/config/dhcp directly. </p>
<p>   config dnsmasq</p>
<pre><code>option domainneeded &apos;1&apos;

option boguspriv &apos;1&apos;

option localise_queries &apos;1&apos;

option local &apos;/lan/&apos;

option domain &apos;lan&apos;

option expandhosts &apos;1&apos;

option authoritative &apos;1&apos;

option readethers &apos;1&apos;

option leasefile &apos;/tmp/dhcp.leases&apos;

option resolvfile &apos;/tmp/resolv.conf.auto&apos;

option rebind_protection &apos;0&apos;

option server &apos;8.8.8.8&apos;

option server &apos;8.8.4.4&apos;
</code></pre><p>In case you want to use OpenDNS (there are 4 public dns servers) </p>
<p>   uci add_list dhcp.@dnsmasq[-1].server=202.67.222.222</p>
<p>   uci add_list dhcp.@dnsmasq[-1].server=202.67.220.220</p>
<p>   uci add_list dhcp.@dnsmasq[-1].server=202.67.222.220</p>
<p>   uci add_list dhcp.@dnsmasq[-1].server=202.67.220.222</p>
<p>   uci commit dhcp</p>
<p>Of course, you can use another dns servers. Just send a SIGHUP to dnsmasq process or restart dnsmasq service to apply the newly added forwarding DNS servers. </p>
<h3 id="Configuring-dnsmasq-to-use-different-IP-ranges-for-wired-and-wireless"><a href="#Configuring-dnsmasq-to-use-different-IP-ranges-for-wired-and-wireless" class="headerlink" title="Configuring dnsmasq to use different IP ranges for wired and wireless"></a>Configuring dnsmasq to use different IP ranges for wired and wireless</h3><p>Suppose you have the following: </p>
<p>   vlan0     Link encap:Ethernet  HWaddr XX:XX:XX:XX:XX:XX</p>
<pre><code>inet addr:192.168.1.1    Bcast:192.168.1.255    Mask:255.255.255.0
</code></pre><p>   eth1      Link encap:Ethernet  HWaddr XX:XX:XX:XX:XX:XX</p>
<pre><code>inet addr:10.75.9.1      Bcast:10.75.9.255      Mask:255.255.255.0
</code></pre><p>Simply put 2 “dhcp-range” options in your </p>
<p>   /etc/dnsmasq.conf</p>
<p>file:</p>
<h1 id="dhcp-range-network-id"><a href="#dhcp-range-network-id" class="headerlink" title="dhcp-range=[network-id,],[[,],][,]"></a>dhcp-range=[network-id,],[[,],][,]</h1><p>   dhcp-range=lan,192.168.1.101,192.168.1.104,255.255.255.0,24h</p>
<p>   dhcp-range=wlan,10.75.9.111,10.75.9.119,255.255.255.0,2h</p>
<p>You can then use the different “network-id” values with “dhcp-option” to customize the options your DHCP server will supply to your wired and wireless DHCP clients. </p>
<p>for example </p>
<p>   set the default route for dhcp clients on the wlan side to 10.10.6.33</p>
<p>   dhcp-option=wlan,3,10.10.6.33</p>
<p>   #set the dns server for the dhcp clients on the wlan side to 10.10.6.33</p>
<p>   dhcp-option=wlan,6,10.10.6.33</p>
<p>   #set the default route for dhcp clients on the lan side to 10.10.6.1</p>
<p>   dhcp-option=lan,3,10.10.6.1</p>
<p>   #set the dns server for the dhcp clients on the lan side to 10.10.6.1</p>
<p>   dhcp-option=lan,6,10.10.6.1</p>
<h3 id="Configuring-dnsmasq-to-generate-DHCP-responses-to-ONLY-known-clients"><a href="#Configuring-dnsmasq-to-generate-DHCP-responses-to-ONLY-known-clients" class="headerlink" title="Configuring dnsmasq to generate DHCP responses to ONLY known clients"></a>Configuring dnsmasq to generate DHCP responses to ONLY known clients</h3><p>There are situations where you want dnsmasq to generate DHCP addresses for only known clients (as defined in <code>/etc/ethers</code>). First, set <code>lan_dhcp_num=0</code> to indicate that no addresses are to be generated. Then, modify the file </p>
<p><code>/etc/init.d/S60dnsmasq</code> to included the lines </p>
<pre><code>if [ &quot;${num:-150}&quot; = &quot;0&quot; ]; then

        END=static

fi
</code></pre><p>after the calls to </p>
<p><code>ipcalc.sh</code> . Restart the daemon or reboot. </p>
<h3 id="Configuring-dnsmasq-to-associate-client-hostnames-with-DHCP-supplied-IP-addresses"><a href="#Configuring-dnsmasq-to-associate-client-hostnames-with-DHCP-supplied-IP-addresses" class="headerlink" title="Configuring dnsmasq to associate client hostnames with DHCP-supplied IP addresses"></a>Configuring dnsmasq to associate client hostnames with DHCP-supplied IP addresses</h3><p>You will need the following lines in your </p>
<p><code>/etc/dnsmasq.conf</code> file: (Adjust IP address if your router is not 192.168.1.1) </p>
<p>   dhcp-option=3,192.168.1.1</p>
<p>   dhcp-option=6,192.168.1.1</p>
<p>That’s it for dnsmasq on the router. The trick is that the DHCP client must send its hostname during the DHCP negotiation. The </p>
<p><code>dhclient.conf</code> file, which may be in <code>/etc/</code> (debian) or <code>/etc/dhcp3/</code> (kubuntu), needs to have a single line uncommented and edited: <code>send host-name &quot;hostname&quot;;</code></p>
<p>Save the file, then restart the interface. Repeat on all client systems. </p>
<h3 id="Configuring-dnsmasq-to-broadcast-WINS-server-information"><a href="#Configuring-dnsmasq-to-broadcast-WINS-server-information" class="headerlink" title="Configuring dnsmasq to broadcast WINS server information"></a>Configuring dnsmasq to broadcast WINS server information</h3><p>You will need the following line in your </p>
<p><code>/etc/dnsmasq.conf</code> file: (Adjust IP address if your WINS server is not 192.168.1.2) <code>dhcp-option=44,192.168.1.2</code></p>
<p>Now as your machines release and renew DHCP information they will obtain the address of the WINS server automatically. </p>
<h3 id="Configuring-dnsmasq-to-broadcast-External-DNS-server-information"><a href="#Configuring-dnsmasq-to-broadcast-External-DNS-server-information" class="headerlink" title="Configuring dnsmasq to broadcast External DNS server information"></a>Configuring dnsmasq to broadcast External DNS server information</h3><p>The following change to your <code>/etc/dnsmasq.conf</code> file will allow for automatic configuration of your DHCP clients to use DNS servers other than one on the router. </p>
<p><code>dhcp-option=6,ipaddress1,ipaddress2</code></p>
<p>Or you can do the same in <code>/etc/config/dhcp</code>: </p>
<p>   …</p>
<p>   config ‘dhcp’ ‘lan’</p>
<pre><code>list &apos;dhcp_option&apos; &apos;6,ipaddress1,ipaddress2&apos;
</code></pre><p>   …</p>
<p>As your machines release and renew their DHCP configuration they will obtain the address of the new DNS servers automatically. </p>
<h3 id="SIP-Phones-and-dnsmasq"><a href="#SIP-Phones-and-dnsmasq" class="headerlink" title="SIP-Phones and dnsmasq"></a>SIP-Phones and dnsmasq</h3><p>By default, the option filterwin2k in dnsmasq is activated, which seems to cause to block queries for <code>SRV</code> records. </p>
<p><code>SRV</code> records are <strong>not only used by Windows</strong> computers to find their domaincontrollers but also used by e.g SIP-Phones to find the server responsible for a given domain. </p>
<p><code>SRV</code> records are a kind of generalized <code>MX</code> records. </p>
<p>Therefore, the <code>filterwin2k</code> option needs to be disabled in order to let SIP-Phones work that use dnsmasq as their DNS server. </p>
<p>Commented out in <code>/etc/dnsmasq.conf</code> or de-activate it in the web-interface. </p>
<p>Or you can do the same in <code>/etc/config/dhcp</code>: </p>
<p>   config ‘dnsmasq’</p>
<pre><code>option &apos;filterwin2k&apos; &apos;0&apos;
</code></pre><p>   …</p>
<h3 id="DNS-filtering"><a href="#DNS-filtering" class="headerlink" title="DNS filtering"></a>DNS filtering</h3><ul>
<li><a href="https://forum.openwrt.org/viewtopic.php?id=35023" title="https://forum.openwrt.org/viewtopic.php?id=35023" target="_blank" rel="external">OpenWrt Forum: Blocking tracking, ad, spyware sites from router</a></li>
</ul>
<h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><h3 id="log-continuously-filled-with-DHCPINFORM-DHCPACK"><a href="#log-continuously-filled-with-DHCPINFORM-DHCPACK" class="headerlink" title="log continuously filled with DHCPINFORM / DHCPACK"></a>log continuously filled with DHCPINFORM / DHCPACK</h3><p>Windows 7 among others ask for proxy settings using DHCP. The issue is that they do not stop asking until they have received an answer. This results in that the log contains a lot information about these requests, an example can be found below (thanks for <a href="http://wiki.excito.org" title="http://wiki.excito.org" target="_blank" rel="external">http://wiki.excito.org</a> for the info). </p>
<p>   Jul 1 06:34:09 MorganB3 dnsmasq-dhcp[1638]: DHCPINFORM(br0) 10.69.10.59 00:23:14:c5:33:fc</p>
<p>   Jul 1 06:34:09 MorganB3 dnsmasq-dhcp[1638]: DHCPACK(br0) 10.69.10.59 00:23:14:c5:33:fc MorgansVaioF12Z</p>
<p>To solve this, edit /etc/dnsmasq.conf and add the following lines: </p>
<h1 id="This-will-tell-DHCP-clients-to-not-ask-for-proxy-information"><a href="#This-will-tell-DHCP-clients-to-not-ask-for-proxy-information" class="headerlink" title="This will tell DHCP clients to not ask for proxy information"></a>This will tell DHCP clients to not ask for proxy information</h1><h1 id="Some-clients-like-Windows-7-will-constantly-ask-if-not-told-NO"><a href="#Some-clients-like-Windows-7-will-constantly-ask-if-not-told-NO" class="headerlink" title="Some clients, like Windows 7, will constantly ask if not told NO"></a>Some clients, like Windows 7, will constantly ask if not told NO</h1><p>   dhcp-option=252,”\n”</p>
<p>and restart dnsmasq with /etc/init.d/dnsmasq restart </p>
<h3 id="Assigning-dnsmasq-Queryport"><a href="#Assigning-dnsmasq-Queryport" class="headerlink" title="Assigning dnsmasq Queryport"></a>Assigning dnsmasq Queryport</h3><p>The queryport is not the dns server port used by dhcp clients, it is the outgoing port dnsmasq uses to query other servers, and is integral to dnsmasq succesfully assigning DNS values to the DHCP clients. The default settings create arbitrary high port number connections on a range of ports. By assigning an option line like “ option queryport ‘30000’ “ in /etc/config/dhcp, one can constrain those connections to a port you assign. Be certain that your firewall allows outbound connections from the router on the query port that you assign. </p>
<p>As a caution, dnsmasq runs as user “nobody” on openwrt so it is not allowed to create listening sockets on ports &lt; 1024. Using the standard DNS port 53 for these queries will fail. The failure can be found in the logs. Logread will show an “ignoring nameserver” error line like: </p>
<p>   Jan 01 01:01:01 MyRoutersName daemon.warn dnsmasq[3490]: ignoring nameserver 8.8.8.8 - cannot make/bind socket: Permission denied</p>
<p>Do not assign query ports less than 1024 to the queryport. </p>
<h2 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h2><ul>
<li><p>Project Homepage: <a href="http://thekelleys.org.uk/dnsmasq/doc.html" title="http://thekelleys.org.uk/dnsmasq/doc.html" target="_blank" rel="external">http://thekelleys.org.uk/dnsmasq/doc.html</a></p>
</li>
<li><p>Tutorial <a href="http://www.enterprisenetworkingplanet.com/netos/article.php/3377351" title="http://www.enterprisenetworkingplanet.com/netos/article.php/3377351" target="_blank" rel="external">http://www.enterprisenetworkingplanet.com/netos/article.php/3377351</a></p>
</li>
<li><p>Tutorial <a href="http://martybugs.net/wireless/openwrt/dnsmasq.cgi" title="http://martybugs.net/wireless/openwrt/dnsmasq.cgi" target="_blank" rel="external">http://martybugs.net/wireless/openwrt/dnsmasq.cgi</a></p>
</li>
</ul>
<p><sup><a href="#fnt__1">1)</a></sup> such as <a href="https://developers.google.com/speed/public-dns/docs/using" title="https://developers.google.com/speed/public-dns/docs/using" target="_blank" rel="external">Google Public DNS</a> and <a href="https://www.opendns.com" title="https://www.opendns.com" target="_blank" rel="external">OpenDNS</a><sup><a href="#fnt__2">2)</a></sup> currently, linux /etc/resolv.conf file is limited to three nameservers, <a href="http://manpages.ubuntu.com/manpages/trusty/man5/resolver.5.html" title="http://manpages.ubuntu.com/manpages/trusty/man5/resolver.5.html" target="_blank" rel="external">see resolv.conf(5) manpage</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://ww1.sinaimg.cn/mw690/48910e01gw1evkbf70jcgj20cg0cidh5.jpg" alt="Liam WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://ww3.sinaimg.cn/mw690/48910e01gw1evkbfendrjj20ci0ci0uf.jpg" alt="Liam Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/dnsmasq/" rel="tag"># dnsmasq</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2013/06/boy-you-had-to-believe-that-two-wrongs-can-just/" rel="next" title="少年你要相信负负是可以得正的">
                <i class="fa fa-chevron-left"></i> 少年你要相信负负是可以得正的
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2013/07/sichuan-tibet-spiritual-practice-by-yourself/" rel="prev" title="川藏修行致自己">
                川藏修行致自己 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2013/06/dnsmasq/"
     data-title="Dnsmasq"
     data-content=""
     data-url="https://blog.naaln.com/2013/06/dnsmasq/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2013/06/dnsmasq/"
           data-title="Dnsmasq" data-url="https://blog.naaln.com/2013/06/dnsmasq/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/3387850?v=3&s=460"
               alt="Liam" />
          <p class="site-author-name" itemprop="name">Liam</p>
          <p class="site-description motion-element" itemprop="description">人生若如初見</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">672</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/liszd" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/whyliam" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.naaln.com/" title="纳兰主页" target="_blank">纳兰主页</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://photo.naaln.com/" title="纳兰相册" target="_blank">纳兰相册</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Dnsmasq"><span class="nav-number">1.</span> <span class="nav-text">Dnsmasq</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration"><span class="nav-number">1.1.</span> <span class="nav-text">Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-config-dhcp"><span class="nav-number">1.1.1.</span> <span class="nav-text">/etc/config/dhcp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-dnsmasq-conf"><span class="nav-number">1.1.2.</span> <span class="nav-text">/etc/dnsmasq.conf</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#allow-etc-hosts-and-dhcp-lookups-via-lan"><span class="nav-number">2.</span> <span class="nav-text">allow /etc/hosts and dhcp lookups via *.lan</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-ethers"><span class="nav-number">2.0.1.</span> <span class="nav-text">/etc/ethers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-hosts"><span class="nav-number">2.0.2.</span> <span class="nav-text">/etc/hosts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS-and-DHCP-Ports"><span class="nav-number">2.0.3.</span> <span class="nav-text">DNS and DHCP Ports</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Examples"><span class="nav-number">2.1.</span> <span class="nav-text">Examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-a-secondary-DNS"><span class="nav-number">2.1.1.</span> <span class="nav-text">Add a secondary DNS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuring-dnsmasq-to-forward-dns-requests-to-public-dns-servers"><span class="nav-number">2.1.2.</span> <span class="nav-text">Configuring dnsmasq to forward dns requests to public dns servers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuring-dnsmasq-to-use-different-IP-ranges-for-wired-and-wireless"><span class="nav-number">2.1.3.</span> <span class="nav-text">Configuring dnsmasq to use different IP ranges for wired and wireless</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dhcp-range-network-id"><span class="nav-number">3.</span> <span class="nav-text">dhcp-range=[network-id,],[[,],][,]</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuring-dnsmasq-to-generate-DHCP-responses-to-ONLY-known-clients"><span class="nav-number">3.0.1.</span> <span class="nav-text">Configuring dnsmasq to generate DHCP responses to ONLY known clients</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuring-dnsmasq-to-associate-client-hostnames-with-DHCP-supplied-IP-addresses"><span class="nav-number">3.0.2.</span> <span class="nav-text">Configuring dnsmasq to associate client hostnames with DHCP-supplied IP addresses</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuring-dnsmasq-to-broadcast-WINS-server-information"><span class="nav-number">3.0.3.</span> <span class="nav-text">Configuring dnsmasq to broadcast WINS server information</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuring-dnsmasq-to-broadcast-External-DNS-server-information"><span class="nav-number">3.0.4.</span> <span class="nav-text">Configuring dnsmasq to broadcast External DNS server information</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SIP-Phones-and-dnsmasq"><span class="nav-number">3.0.5.</span> <span class="nav-text">SIP-Phones and dnsmasq</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS-filtering"><span class="nav-number">3.0.6.</span> <span class="nav-text">DNS filtering</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshooting"><span class="nav-number">3.1.</span> <span class="nav-text">Troubleshooting</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#log-continuously-filled-with-DHCPINFORM-DHCPACK"><span class="nav-number">3.1.1.</span> <span class="nav-text">log continuously filled with DHCPINFORM / DHCPACK</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#This-will-tell-DHCP-clients-to-not-ask-for-proxy-information"><span class="nav-number">4.</span> <span class="nav-text">This will tell DHCP clients to not ask for proxy information</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Some-clients-like-Windows-7-will-constantly-ask-if-not-told-NO"><span class="nav-number">5.</span> <span class="nav-text">Some clients, like Windows 7, will constantly ask if not told NO</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Assigning-dnsmasq-Queryport"><span class="nav-number">5.0.1.</span> <span class="nav-text">Assigning dnsmasq Queryport</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Notes"><span class="nav-number">5.1.</span> <span class="nav-text">Notes</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2003 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liam</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"naalnblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



</body>
</html>
